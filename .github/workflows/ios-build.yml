name: iOS Build IPA
on:
  push:
    branches: [ main ]
jobs:
  build-ipa:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode 16.2
      run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get Flutter dependencies
      run: flutter pub get
      
    - name: Generate Flutter iOS files
      run: flutter precache --ios
        
    - name: Setup iOS certificates and provisioning profiles
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
        echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
        
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: Create ExportOptions.plist
      run: |
        cd ios
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
    - name: Build iOS without signing (Flutter step)
      run: flutter build ios --release --no-codesign
        
    - name: Archive and Sign with Xcode
      run: |
        cd ios
        
        # Archive the app
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -destination generic/platform=iOS \
          -archivePath Runner.xcarchive \
          archive \
          CODE_SIGN_STYLE=Manual \
          PROVISIONING_PROFILE_SPECIFIER="com.teammatesapp.app" \
          CODE_SIGN_IDENTITY="Apple Distribution: Arman J"
        
        # Export to IPA
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath ../build/ios/iphoneos \
          -exportOptionsPlist ExportOptions.plist
        
        # Rename the IPA to match your expected name
        cd ../build/ios/iphoneos
        mv *.ipa TeamMates.ipa
        
        # Verify the IPA was created and signed
        echo "IPA created successfully:"
        ls -la TeamMates.ipa
        echo "Checking code signature:"
        codesign -dv --verbose=4 TeamMates.ipa
        
    - name: Upload IPA as Downloadable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: TeamMates-iOS-App
        path: build/ios/iphoneos/TeamMates.ipa
        retention-days: 30
        
    - name: Clean up keychain
      if: ${{ always() }}
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        
    - name: Build Summary
      run: |
        echo "ðŸŽ‰ Build completed successfully!"
        echo "ðŸ“± Download your IPA from the Artifacts section below"
        echo "ðŸ“… Available for 30 days"
