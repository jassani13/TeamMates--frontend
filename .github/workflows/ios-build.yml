name: iOS Build IPA
on:
  push:
    branches: [ main ]
jobs:
  build-ipa:
    runs-on: macos-15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode 16.2 and iOS SDK
      run: |
        sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
        # Install iOS 18.2 platform if not available
        xcodebuild -downloadPlatform iOS || true
        # List available platforms
        xcodebuild -showsdks
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        
    - name: Get Flutter dependencies
      run: flutter pub get
      
    - name: Generate Flutter iOS files
      run: flutter precache --ios
        
    - name: Setup iOS certificates and provisioning profiles
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode --output $CERTIFICATE_PATH
        echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode --output $PP_PATH
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/
        
    - name: Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: Create ExportOptions.plist
      run: |
        cd ios
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>L2J8AW86LW</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.teammatesapp.app</key>
                <string>com.teammatesapp.app</string>
            </dict>
            <key>signingStyle</key>
            <string>manual</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
        </dict>
        </plist>
        EOF
        
    - name: Build iOS without signing (Flutter step)
      run: |
        # First, check available iOS SDKs
        xcodebuild -showsdks | grep iOS
        
        # Build with explicit SDK version
        flutter build ios --release --no-codesign
        
    - name: Archive and Sign with Xcode
      timeout-minutes: 30
      run: |
        cd ios
        
        # Use available iOS SDK version
        AVAILABLE_SDK=$(xcodebuild -showsdks | grep -o 'iphoneos[0-9.]*' | head -1)
        echo "Using SDK: $AVAILABLE_SDK"
        
        # Archive the app with available SDK - ONLY apply signing to Runner target
        echo "üî® Starting archive process..."
        xcodebuild -workspace Runner.xcworkspace \
          -scheme Runner \
          -configuration Release \
          -sdk $AVAILABLE_SDK \
          -archivePath Runner.xcarchive \
          archive \
          -verbose \
          DEVELOPMENT_TEAM="L2J8AW86LW" \
          CODE_SIGN_STYLE=Manual \
          CODE_SIGN_IDENTITY="Apple Distribution: Arman J" \
          PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*]="com.teammatesapp.app"
        
        echo "‚úÖ Archive completed successfully!"
        
        # Verify archive was created
        if [ ! -d "Runner.xcarchive" ]; then
          echo "‚ùå Archive not found!"
          exit 1
        fi
        
        echo "üì¶ Starting IPA export..."
        # Export to IPA
        xcodebuild -exportArchive \
          -archivePath Runner.xcarchive \
          -exportPath ../build/ios/iphoneos \
          -exportOptionsPlist ExportOptions.plist \
          -verbose
        
        echo "‚úÖ Export completed!"
        
        # Find and rename the IPA
        cd ../build/ios/iphoneos
        IPA_FILE=$(find . -name "*.ipa" | head -1)
        
        if [ -z "$IPA_FILE" ]; then
          echo "‚ùå No IPA file found!"
          ls -la
          exit 1
        fi
        
        mv "$IPA_FILE" TeamMates.ipa
        
        # Verify the IPA was created and signed
        echo "üéâ IPA created successfully:"
        ls -la TeamMates.ipa
        echo "üîç Checking code signature:"
        codesign -dv --verbose=4 TeamMates.ipa
        
    - name: Upload IPA as Downloadable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: TeamMates-iOS-App
        path: build/ios/iphoneos/TeamMates.ipa
        retention-days: 30
        
    - name: Clean up keychain
      if: ${{ always() }}
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        
    - name: Build Summary
      run: |
        echo "üéâ Build completed successfully!"
        echo "üì± Download your IPA from the Artifacts section below"
        echo "üìÖ Available for 30 days"
